<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <template id="invoice_report_hide_prices_html_pdf"
              inherit_id="account.report_invoice_document">

      <!-- ====================== HEADERS ====================== -->

      <!-- Unit Price header -->
      <xpath expr="//table[@name='invoice_line_table']/thead/tr/th[@name='th_priceunit']" position="replace">
        <t t-set="priceable_lines"
           t-value="o.invoice_line_ids.filtered(lambda l: l.display_type == 'product' and l.account_id)"/>
        <t t-set="has_price_lines" t-value="bool(priceable_lines)"/>
        <!-- show_prices if there is at least one NOT hidden line, or no price lines at all -->
        <t t-set="show_prices"
           t-value="(not has_price_lines) or bool(priceable_lines.filtered(lambda l: not l.sale_line_cb))"/>

        <t t-if="show_prices">
          <th name="th_priceunit" t-attf-class="text-end text-nowrap {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"><span>Unit Price</span></th>
        </t>
        <t t-else="">
          <!-- COL_EMPTY: keep empty header cell to preserve layout -->
          <th name="th_priceunit" t-attf-class="text-end text-nowrap {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"></th>
        </t>
      </xpath>

      <!-- Discount header (always present when display_discount; cells will blank per-line in body) -->
      <xpath expr="//table[@name='invoice_line_table']/thead/tr/th[@name='th_discount']" position="replace">
        <t t-if="display_discount">
          <th name="th_discount" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
            <span>Disc.%</span>
          </th>
        </t>
      </xpath>

      <!-- Taxes header -->
      <xpath expr="//table[@name='invoice_line_table']/thead/tr/th[@name='th_taxes']" position="replace">
        <t t-set="priceable_lines"
           t-value="o.invoice_line_ids.filtered(lambda l: l.display_type == 'product' and l.account_id)"/>
        <t t-set="has_price_lines" t-value="bool(priceable_lines)"/>
        <t t-set="show_prices"
           t-value="(not has_price_lines) or bool(priceable_lines.filtered(lambda l: not l.sale_line_cb))"/>

        <t t-if="show_prices">
          <th name="th_taxes" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"><span>Taxes</span></th>
        </t>
        <t t-else="">
          <!-- COL_EMPTY -->
          <th name="th_taxes" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"></th>
        </t>
      </xpath>

      <!-- Amount header -->
      <xpath expr="//table[@name='invoice_line_table']/thead/tr/th[@name='th_subtotal']" position="replace">
        <t t-set="priceable_lines"
           t-value="o.invoice_line_ids.filtered(lambda l: l.display_type == 'product' and l.account_id)"/>
        <t t-set="has_price_lines" t-value="bool(priceable_lines)"/>
        <t t-set="show_prices"
           t-value="(not has_price_lines) or bool(priceable_lines.filtered(lambda l: not l.sale_line_cb))"/>

        <t t-if="show_prices">
          <th name="th_subtotal" class="text-end"><span>Amount</span></th>
        </t>
        <t t-else="">
          <!-- COL_EMPTY -->
          <th name="th_subtotal" class="text-end"></th>
        </t>
      </xpath>

      <!-- ====================== BODY (product rows) ====================== -->
      <!-- Replace the whole product-line content block -->
      <xpath expr="//table[@name='invoice_line_table']//t[@name='account_invoice_line_accountable']" position="replace">
        <t name="account_invoice_line_accountable" t-if="line.display_type == 'product'">
          <!-- recompute flags in-row (works for HTML and PDF) -->
          <t t-set="priceable_lines"
             t-value="o.invoice_line_ids.filtered(lambda l: l.display_type == 'product' and l.account_id)"/>
          <t t-set="has_price_lines" t-value="bool(priceable_lines)"/>
          <t t-set="show_prices"
             t-value="(not has_price_lines) or bool(priceable_lines.filtered(lambda l: not l.sale_line_cb))"/>

          <!-- Description -->
          <td name="account_invoice_line_name">
            <span t-if="line.name" t-field="line.name" t-options="{'widget': 'text'}"/>
          </td>

          <!-- Quantity -->
          <td name="td_quantity" class="o_td_quantity text-end">
            <span t-field="line.quantity" class="text-nowrap"/>
            <span t-field="line.product_uom_id" groups="uom.group_uom"/>
          </td>

          <!-- Unit Price -->
          <t t-if="show_prices">
            <td name="td_price_unit" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
              <t t-if="not line.sale_line_cb">
                <span class="text-nowrap" t-field="line.price_unit"/>
              </t>
            </td>
          </t>
          <t t-else="">
            <!-- COL_EMPTY -->
            <td name="td_price_unit" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"></td>
          </t>

          <!-- Discount (present only if display_discount; blank per hidden line) -->
          <t t-if="display_discount">
            <t t-if="show_prices">
              <td name="td_discount" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
                <t t-if="not line.sale_line_cb">
                  <span class="text-nowrap" t-field="line.discount"/>
                </t>
              </td>
            </t>
            <t t-else="">
              <!-- COL_EMPTY -->
              <td name="td_discount" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"></td>
            </t>
          </t>

          <!-- Taxes -->
          <t t-set="taxes" t-value="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_ids])"/>
          <t t-if="show_prices">
            <td name="td_taxes"
                t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }} {{ 'text-nowrap' if len(taxes) &lt; 10 else '' }}">
                <span t-out="taxes" id="line_tax_ids"/>
            </td>
          </t>
          <t t-else="">
            <!-- COL_EMPTY -->
            <td name="td_taxes" t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}"></td>
          </t>

          <!-- Amount/Subtotal -->
          <t t-if="show_prices">
            <td name="td_subtotal" class="text-end o_price_total">
              <t t-if="not line.sale_line_cb">
                <span class="text-nowrap" t-field="line.price_subtotal"/>
              </t>
            </td>
          </t>
          <t t-else="">
            <!-- COL_EMPTY -->
            <td name="td_subtotal" class="text-end o_price_total"></td>
          </t>
        </t>
      </xpath>

    </template>

  </data>
</odoo>